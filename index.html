<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>P2P Chat Test</title>
<style>
body { font-family: Arial; max-width: 600px; margin: auto; }
input, button { padding: 8px; margin: 4px 0; width: 100%; }
#box { border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 5px; }
.msg { margin: 5px 0; }
.me { color: blue; }
.other { color: green; }
</style>
</head>
<body>

<h2>P2P Chat</h2>

<label>Peer API base (VD: http://127.0.0.1:10005)</label>
<input id="base" placeholder="http://127.0.0.1:10005">

<label>Username</label>
<input id="user">

<label>Password</label>
<input id="pass" type="password">

<button onclick="login()">Login</button>
<button onclick="startPeer()">Start Peer</button>

<hr>

<label>Send DM to</label>
<input id="to">

<label>Message</label>
<input id="msg">

<button onclick="sendDM()">Send DM</button>

<hr>

<h3>Messages</h3>
<div id="box"></div>

<script>
let BASE = "";
let USER = "";

function log(text, cls="") {
  let d = document.createElement("div");
  d.className = "msg " + cls;
  d.innerText = text;
  box.appendChild(d);
  box.scrollTop = box.scrollHeight;
}

async function api(path, data=null) {
  let res = await fetch(BASE + path, {
    method: data ? "POST" : "GET",
    headers: {"Content-Type": "application/json"},
    body: data ? JSON.stringify(data) : null
  });
  return res.json();
}

async function login() {
  BASE = document.getElementById("base").value;
  USER = document.getElementById("user").value;
  let pass = document.getElementById("pass").value;

  let r = await api("/login", {username: USER, password: pass});
  log("login: " + JSON.stringify(r));
}

async function startPeer() {
  let port = prompt("P2P listen port? (vd: 9005)");
  let r = await api("/start", {port: Number(port)});
  log("start: " + JSON.stringify(r));
}

async function sendDM() {
  let to = document.getElementById("to").value;
  let msg = document.getElementById("msg").value;
  let r = await api("/dm", {to, message: msg});
  log("me â†’ " + to + ": " + msg, "me");
}

async function poll() {
  if (!BASE || !USER) return;

  let r = await api("/messages?channel=dm:" + USER);
  box.innerHTML = "";
  r.forEach(m => {
    log(m.from + ": " + m.message, "other");
  });
}

setInterval(poll, 1000);
</script>
</body>
</html>
