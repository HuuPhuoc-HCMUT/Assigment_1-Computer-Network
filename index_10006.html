<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>P2P Web Chat</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 20px auto;
      background: #f2f2f2;
    }

    h2 { margin-top: 0; }

    .row {
      display: flex;
      gap: 10px;
    }

    #peer-list {
      width: 220px;
      border: 1px solid #ccc;
      background: #fff;
      padding: 10px;
    }

    .peer {
      padding: 6px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    .peer:hover {
      background: #e9e9e9;
    }

    #chat {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    #chat-header {
      background: #fff;
      padding: 8px;
      border: 1px solid #ccc;
      margin-bottom: 5px;
    }

    #chat-box {
      flex: 1;
      border: 1px solid #ccc;
      background: #fff;
      padding: 10px;
      overflow-y: auto;
      margin-bottom: 5px;
    }

    .msg {
      margin: 6px 0;
    }

    .from {
      font-weight: bold;
    }

    #controls {
      display: flex;
      gap: 5px;
    }

    input, button {
      padding: 6px;
      font-size: 14px;
    }

    #msgInput {
      flex: 1;
    }

    .system {
      color: #777;
      font-style: italic;
    }
  </style>
</head>
<body>

<h2>P2P Web Chat</h2>

<!-- LOGIN -->
<div>
  <input id="username" value="user2" placeholder="username">
  <input id="password" value="123456" type="password" placeholder="password">
  <button onclick="login()">Login</button>
</div>

<!-- START -->
<div style="margin-top:6px;">
  <input id="p2pPort" value="9006" placeholder="P2P port">
  <button onclick="startPeer()">Start Peer</button>
</div>

<hr>

<div class="row">

  <!-- PEER LIST -->
  <div id="peer-list">
    <button onclick="loadPeers()">Get peer list</button>
    <div id="peers"></div>
  </div>

  <!-- CHAT -->
  <div id="chat">
    <div id="chat-header">
      Chat with: <span id="chatTarget">Global Chat</span>
      <button onclick="switchToGlobal()" style="margin-left:10px;">
        Global
      </button>
    </div>


    <div id="chat-box"></div>

    <div id="controls">
      <input id="msgInput" placeholder="Type a message">
      <button onclick="send()">Send</button>
    </div>
  </div>

</div>

<script>
const API = "http://127.0.0.1:10006";

// let currentTarget = null;
// let currentChannel = null;
// let lastCount = 0;

let currentTarget = null;
let currentChannel = "global";
let lastCount = 0;

document.getElementById("chatTarget").innerText = "Global Chat";


// ---------- AUTH ----------
async function login() {
  await fetch(API + "/login", {
    method: "POST",
    credentials: "include",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
      username: username.value,
      password: password.value
    })
  });
  logSystem("Logged in");
}

async function startPeer() {
  await fetch(API + "/start", {
    method: "POST",
    credentials: "include",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ port: Number(p2pPort.value) })
  });
  logSystem("Peer started");
}

// ---------- PEERS ----------
// async function loadPeers() {
//   const r = await fetch(API + "/peers?channel=global");
//   const peers = await r.json();

//   const box = document.getElementById("peers");
//   box.innerHTML = "";

//   peers.forEach(p => {
//     const div = document.createElement("div");
//     div.className = "peer";
//     div.innerText = p.username;
//     div.onclick = () => openChat(p.username);
//     box.appendChild(div);
//   });
// }


async function loadPeers() {
  try {
    const r = await fetch(API + "/peers?channel=global", {
      credentials: "include"
    });
    const peers = await r.json();

    const box = document.getElementById("peers");
    box.innerHTML = "";

    peers.forEach(p => {
      const div = document.createElement("div");
      div.className = "peer";
      div.innerText = p.username;
      div.onclick = () => openChat(p.username);
      box.appendChild(div);
    });
  } catch (e) {
    console.error("loadPeers error:", e);
  }
}


function openChat(user) {
  currentTarget = user;
  currentChannel = "dm:" + user;
  lastCount = 0;
  document.getElementById("chatTarget").innerText = user;
  document.getElementById("chat-box").innerHTML = "";
  logSystem("Chat opened with " + user);
}

// ---------- SEND ----------
// async function send() {
//   if (!currentTarget) return;

//   const text = msgInput.value.trim();
//   if (!text) return;

//   msgInput.value = "";

//   await fetch(API + "/dm", {
//     method: "POST",
//     headers: {"Content-Type": "application/json"},
//     body: JSON.stringify({
//       to: currentTarget,
//       message: text
//     })
//   });

//   logMessage("me", text);
// }



async function send() {
  const text = msgInput.value.trim();
  if (!text) return;
  msgInput.value = "";

  // ---- CHAT ALL ----
  if (currentTarget === null) {
    await fetch(API + "/broadcast", {
      method: "POST",
      credentials: "include",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ message: text })
    });
  }
  // ---- DM ----
  else {
    await fetch(API + "/dm", {
      method: "POST",
      credentials: "include",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        to: currentTarget,
        message: text
      })
    });
  }

  logMessage("me", text);
}



function switchToGlobal() {
  currentTarget = null;
  currentChannel = "global";
  lastCount = 0;

  document.getElementById("chatTarget").innerText = "Global Chat";
  document.getElementById("chat-box").innerHTML = "";
  logSystem("Switched to global chat");
}




// ---------- POLLING ----------
async function poll() {
  if (!currentChannel) return;

  try {
    const r = await fetch(API + "/messages?channel=" + currentChannel, {
      credentials: "include"
    });
    const msgs = await r.json();

    if (msgs.length > lastCount) {
      msgs.slice(lastCount).forEach(m => {
        logMessage(m.from, m.message);
      });
      lastCount = msgs.length;
    }
  } catch (e) {}
}

setInterval(poll, 1000);

// ---------- UI ----------
function logMessage(from, msg) {
  const div = document.createElement("div");
  div.className = "msg";
  div.innerHTML = `<span class="from">${from}</span>: ${msg}`;
  chatBox().appendChild(div);
  chatBox().scrollTop = chatBox().scrollHeight;
}

function logSystem(msg) {
  const div = document.createElement("div");
  div.className = "msg system";
  div.innerText = "[system] " + msg;
  chatBox().appendChild(div);
}

function chatBox() {
  return document.getElementById("chat-box");
}
</script>

</body>
</html>
